# 機械学習で、TL上のポプテピピックに関するツイートにモザイクを掛ける(前編)
2018/02/07

## はじめに
最近、大川ぶくぶ著「ポプテピピック」がアニメ化されましたね。   
Twitter上では大人気。放映中はタイムラインも大賑わい。   

[](https://twitter.com/anofelus/status/783866432392040448)

しかし、僕は父と母と小さなアパートで暮らしているので、
あの時間帯にテレビを付けてしまうと父や母を起こしてしまいます...。

アニメを見るときは大きな音量でテレビを通して見たい僕。
リアルタイムにポプテピピックを楽しむことは出来ません。   

リアルタイムにポプテピピックを見られない僕は、
ポプテピピックの放映中にネタバレを見たくないワケですが、
意地でもTwitterをやめたくない....

そこで、ポプテピピックに関連するツイートにモザイクを掛ける
Google Chrome拡張機能を作ることとしました。

## 要件

まず、必要な機能を定義します。

Google Chrome上で\*.twitter.com/\*を表示している時に、
ポプテピピックに関連するツイートに対してモザイクを掛ける機能を作ります。

この時、「ポプテピピック」「PPTP」などの単語が含まれていないツイートについても検出する必要があります。

### 例1: ポプテピピックに関するネタツイート
[](https://twitter.com/rekkuuzadx/status/958351512509472770)
この場合、「何気ない○○が△△をきずつけた」などのテンプレートが存在しているため、
Twitterのワードミュート機能を利用することで十分対応できそうです。

### 例2: 実況ツイート
[](https://twitter.com/rekkuuzadx/status/957283774328270848)
このツイートがポプテピピックの実況ツイートであることは、その放送をリアルタイムで見ていなければ分かりません。
もしくは、リアルタイムに [#ポプテピピック](https://twitter.com/search?q=ポプテピピック) などのハッシュタグが付いた実況ツイートを監視する必要があります。

つまり、過去の放送のみならず、現在放送中の話に対する実況ツイートについても、
リアルタイムに [#ポプテピピック](https://twitter.com/search?q=ポプテピピック) から学習し、
これを即座に判定結果へ反映する必要があります。

## 判定アルゴリズムの検討

テキストを特徴ベクトル化し、SVMやランダムフォレストによって判定する場合を考えます。
SVMやランダムフォレストは、学習の度に蓄積された全データから学習し直さなければなりません。
その為、例えば学習に10分を要する場合、最新10分間の実況ツイートを弾くことは出来ません。

ここで、オンライン学習(逐次学習)アルゴリズムを検討します。
オンライン学習は、学習データが1つずつ与えられ、データが与えられる度にパラメータを更新します。
オンライン学習の代表的な手法として、次が挙げられます。

* PA (Passive-Agressive)
[[Crammer et al., 2006]](http://jmlr.csail.mit.edu/papers/volume7/crammer06a/crammer06a.pdf)
* CW (Confidence Weighted)
[[Dredze et al., 2008]](https://www.cs.jhu.edu/~mdredze/publications/icml_variance.pdf)
* AROW (Adaptive Regularization of Weight Vectors)
[[Crammer et al., 2009b]](https://papers.nips.cc/paper/3848-adaptive-regularization-of-weight-vectors.pdf)
* SCW (Soft Confidence-Weighted Learning)
[[J Wang et al., ‎2012]](https://icml.cc/2012/papers/86.pdf)

参考
* [【オンライン機械学習】 Go で PA, CW, AROW, SCW を書いてみた【gonum/mat64】](https://fisproject.jp/2016/01/online-machine-learning-in-go/)
* [オンライン線形分類器とSCW](http://kazoo04.hatenablog.com/entry/2012/12/20/000000)

これはkazoo04氏も上記の記事で仰っていることですが、パラメータを十分にチューニングした場合はAROWよりもSCWの方が高い精度をもたらしますが、
SCWはハイパーパラメータが2つあるためチューニングが面倒な一方で、AROWはハイパーパラメータが1つである上にあまり鋭敏に反応しないので、
とりあえずパパッと何かそれなりに動くものが欲しい場合はAROWを、十分にチューニングした上で高い精度を発揮したい場合はSCWを使うようにしています。

今回は、とりあえずまともに動けばいいので、AROWを用います。

## 特徴設計

* 形態素解析
MeCabによって分かち書きして得られた単語Bag-of-words
* n-gram
  * unigram
  * bigram
  * trigram

Bag-of-wordsだけでなくn-gramを用いた理由として、「クソネミミッミ」など、単語としてはほとんど存在しないが、音の響きが明らかにポプテピピックをリスペクトしている単語についても判定したかったためです。

## データ収集

Twitter から提供されているAPIを用います。

### 正例(ポプテピピックであるツイート)の集め方
Twitter REST APIの検索APIと、Twitter Streaming APIのfilterAPIを用います。

Twitter REST APIの検索APIは1回叩くごとに最大で100ツイート取得可能で、15分で450回叩くことが許可されています。
つまり、15分で45000ツイート収集することが出来ます。また、max_idを指定することで、あるツイートよりも以前のツイートについて検索することが出来るため、
過去について遡ることが可能です。

Twitter Streaming APIのfilterAPIは、指定した検索クエリに対して得られた検索結果をリアルタイムに得ることが可能です。
放映時にはこのAPIを用いてツイートを学習することが適切であると考えられます。

### 負例(ポプテピピックでないツイート)の集め方
Twitter Streaming APIのSample Streaming APIを用います。

Sample Streaming APIは、全世界の1%のツイートをリアルタイムに得ることが可能なAPIです。
今回は、日本語のツイートのみを学習対象としました。
ただし、時々ポプテピピックに関するツイートが流れてくるため、「#PPTP」もしくは「#ポプテピピック」を含むツイートについては正例としました。

## 設計

以下のように構成しています。

[](https://twitter.com/killedbynlp/status/960898769020571651)

* Google Chrome
twitter.com を表示する。   
タイムラインが更新されたら、ラベリングされていないツイートのIDとテキストのリストを   
JSON形式でDjangoのWebサーバに送信し、結果を問い合わせる。   
結果が戻ってきたら、ポプテピピックに関するツイートであると判定されたツイートに対して、
CSSを用いてモザイクをかける。
* Django
Webサーバ。   
Google Chrome側からJSON形式による問い合わせを受け取り、
前処理を施した上でテキストを送信し、判定サーバであるJubatusに問い合わせる。
* Jubatus
判定サーバ。   
Jubatusはオンライン機械学習向け分散処理フレームワークであり、
複数の学習/判定サーバを用意して分散処理することが可能な上に、
MeCabによる形態素解析やn-gramによる特徴変換を行ってくれるスグレモノです。
日本語のテキストを中継サーバに送信するだけで、自動で特徴変換・学習/分類を行ってくれます。
* MySQL
教師データを格納するデータベースサーバ。
* Tweepy
Python向けのTwitter APIラッパー。
Tweepyで教師データを収集し、MySQLに格納します。

Jubatusについては、詳しくは以下のスライドにまとめてあります。   
ただし、 **講義で他の学生向けに説明する際に作成した資料** なので、 **本当にひどい雑な表現が多く含まれている** ことをご留意下さい。
[](//www.slideshare.net/slideshow/embed_code/key/m8MsJL4raZXei5)

## 実装
GitHubに一応公開してありますが、まだドキュメントを整備していません。ごめんなさい。

[GitHub - クライアント側](https://github.com/KilledByNLP/twitter-unpoptefy-chrome-extension)
[GitHub - サーバ側](https://github.com/KilledByNLP/twitter-unpoptefy-server)

## 評価

リアルタイムに学習した場合の結果については次回の放送時に行い、
本記事の後編として紹介する予定です。

今回は、友人にご協力頂き、過去のポプテピピックの実況ツイートについて評価を行いました。   
アノテーションなどの手間の都合上、F値などの定量的な値での評価は今回省略しています。

以下のように、「#ポプテピピック」などのタグが付与されていない場合でも、   
画面に表示された20件程度のポプテピピックの実況ツイートかどうかについて、
30ms程度で適切に判定することができました。

### 適用前
![](https://i.imgur.com/I1YKwLe.png)

### 適用後
![](https://i.imgur.com/vV7djpl.png)

個人的には、実況ツイートの間に存在しているポプテピピックと関係ないツイートについてきっちり判定できている点が嬉しいです。

体感としては、過去のポプテピピックの実況ツイートであれば、適合率およそ90%、再現率およそ80~90%程度は出ているかと思われますが、
リアルタイムに学習・判定する場合についてや、どの特徴素が結果に影響しているか、具体的な定量的評価などは後半に回したいと思います。

## 最後に
本記事では、様々な方からの幅広いご意見を募集しております。
もしよろしければ、[twitter.com/KilledByNLP](https://twitter.com/KilledByNLP)までご提案・ご意見・ご感想を頂けますと幸いです。

